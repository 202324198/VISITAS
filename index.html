<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Orden de Trabajo Catastral - FINAL (Preparado para Backend)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #333; }
        .page {
            width: 8.5in;
            min-height: 11in;
            margin: 0 auto;
            padding: 0.5in;
            box-sizing: border-box;
            background: white;
            border: 1px solid #ccc;
        }
        .header-container { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .logo-box { width: 100px; height: 100px; border: 1px solid #ddd; text-align: center; line-height: 100px; font-size: 0.7rem; color: #777; }
        .title-area { flex-grow: 1; text-align: center; padding: 0 15px; }
        h1 { font-size: 1.3rem; margin: 5px 0; border-bottom: 2px solid #a83a6f; padding-bottom: 5px; color: #a83a6f; }
        h2 { font-size: 1rem; margin: 0 0 5px 0; color: #333; }
        
        .row-container { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .col-half { flex: 1; min-width: 45%; }
        
        .field-group { margin-bottom: 5px; }
        .field-group label { display: block; font-weight: bold; margin-bottom: 3px; font-size: 0.8rem; }
        
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.85rem;
        }
        
        /* Estilo para Folio generado por el sistema */
        #folio { background-color: #f0f8ff; font-weight: bold; color: #0056b3; }

        /* Estilos del mapa y botones de acción */
        #map { height: 180px; border-radius: 4px; margin-top: 5px; }
        .action-container { margin-top: 10px; margin-bottom: 10px; display: flex; gap: 8px; justify-content: flex-start; }
        .action-container button, .map-actions button { 
            padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; 
            background: #a83a6f; color: white; font-weight: 600; font-size: 0.85rem; 
            transition: background 0.2s;
        }
        .action-container button:hover, .map-actions button:hover { background: #8b2c55; }
        .action-container button.secondary, .map-actions button.secondary { background: #555; }
        
        .drawing-area { border: 1px dashed #ccc; height: 160px; padding: 5px; margin-top: 5px; }
        #qrcode { 
            width: 100px; height: 100px; 
            border: 1px dashed #333; 
            text-align: center; 
            margin-left: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            font-size: 0.7rem;
        }
        
        .signatures { margin-top: 20px; display: flex; justify-content: space-around; text-align: center; border-top: 1px solid #ccc; padding-top: 15px; }
        .signature-box { width: 22%; }
        .signature-line { border-bottom: 1px solid #333; height: 1px; margin-bottom: 5px; }
        .signature-label { font-size: 0.75rem; font-style: italic; }

        /* Estilos de impresión */
        @media print {
            .page { border: none; margin: 0; padding: 0.5in; width: 100%; height: 100%; page-break-after: always; }
            .action-container, .map-actions { display: none; }
            input, select, textarea {
                border: none !important;
                border-bottom: 1px dotted #333 !important;
                padding: 0 0 2px 0 !important;
                background-color: transparent !important;
            }
            #map { height: 150px !important; }
            .drawing-area, #qrcode { border: 1px dashed #333 !important; }
            .logo-box { border: none; }
        }
    </style>
</head>
<body>
<div class="page">
    
    <div class="header-container">
        <div class="logo-box">LOGO MUNICIPAL</div>
        <div class="title-area">
            <h1>COORDINACIÓN DE CATASTRO</h1>
            <h2>ORDEN DE TRABAJO</h2>
        </div>
        <div class="logo-box">LOGO CATASTRAL</div>
    </div>

    <form id="catastroForm"> <div class="row-container">
            <div class="field-group" style="flex: 1 1 50%;">
                <label for="nombre">Nombre / Solicitante</label>
                <input id="nombre" name="nombre" type="text" placeholder="Nombre del propietario o solicitante" required>
            </div>
            <div class="field-group" style="flex: 1 1 30%;">
                <label for="tramite">Trámite</label>
                <select id="tramite" name="tramite" required>
                    <option value="">-- Selecciona --</option>
                    <option>Certificado de clave y valor</option>
                    <option>Traslado de dominio</option>
                    <option>Actualización catastral</option>
                </select>
            </div>
            <div class="field-group" style="flex: 0 0 15%;">
                <label for="fecha" style="font-weight: bold;">FECHA:</label>
                <input id="fecha" name="fecha" type="text" value="" readonly>
            </div>
        </div>
    
        <div class="row-container">
            <div class="field-group col-half">
                <label for="colonia">Colonia y/o Pueblo</label>
                <input id="colonia" name="colonia" type="text" placeholder="Colonia o Pueblo">
            </div>
            <div class="field-group col-half">
                <label for="direccion">Dirección / Calle (Opcional)</label>
                <input id="direccion" name="direccion" type="text" placeholder="Calle, número, referencia">
            </div>
        </div>
        
        <div class="row-container">
            <div class="field-group" style="flex: 1 1 30%;">
                <label for="clave">Clave Catastral</label>
                <input id="clave" name="clave" type="text" placeholder="Ej: 000-000-000" required>
            </div>
            <div class="field-group" style="flex: 1 1 30%;">
                <label for="folio">Folio Catastral</label>
                <input id="folio" name="folio" type="text" placeholder="Folio Único" readonly>
            </div>
            <div class="field-group" style="flex: 1 1 30%;">
                <label for="usoSuelo">Uso de Suelo (P.M.D.U.)</label>
                <select id="usoSuelo" name="usoSuelo">
                    <option value="">-- Selecciona --</option>
                    <option>Habitacional</option>
                    <option>Comercial</option>
                    <option>Mixto</option>
                </select>
            </div>
        </div>
    
        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
    
        <div class="row-container">
            <div class="col-half">
                <h2>LOCALIZACIÓN DEL INMUEBLE (Mapa)</h2>
                <div id="map"></div>
                <div class="map-actions">
                    <button type="button" id="useLocation">Usar ubicación actual</button>
                    <button type="button" class="secondary" id="clearMarker">Limpiar ubicación</button>
                </div>
                <div class="row-container" style="margin-top: 5px;">
                    <div class="field-group col-half">
                        <label for="lat">Latitud (DD)</label>
                        <input id="lat" name="lat" type="number" step="0.000001" placeholder="19.xxxxxx" required>
                    </div>
                    <div class="field-group col-half">
                        <label for="lon">Longitud (DD)</label>
                        <input id="lon" name="lon" type="number" step="0.000001" placeholder="-98.xxxxxx" required>
                    </div>
                </div>
            </div>
            
            <div class="col-half">
                <h2>CROQUIS / COLINDANCIAS / MEDIDAS</h2>
                <div class="field-group">
                    <label>Descripción de Medidas y Colindancias</label>
                    <textarea id="colindancias" name="colindancias" rows="3" placeholder="Norte: 20m, Sur: 21m, etc."></textarea>
                </div>
                <label>Área de Dibujo del Predio (Cuadrícula)</label>
                <div class="drawing-area">
                    </div>
            </div>
        </div>
    
        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 10px 0;">
    
        <div class="row-container">
            <div class="field-group" style="flex: 1 1 20%;">
                <label for="superficie">Superficie Terreno (m²)</label>
                <input id="superficie" name="superficie_terreno" type="number" step="0.01" placeholder="0.00">
            </div>
            <div class="field-group" style="flex: 1 1 20%;">
                <label for="superConstruccion">Superficie Construcción (m²)</label>
                <input id="superConstruccion" name="superficie_construccion" type="number" step="0.01" placeholder="0.00">
            </div>
            <div class="field-group" style="flex: 1 1 20%;">
                <label for="topografia">Topografía</label>
                <select id="topografia" name="topografia">
                    <option value="">-- Selecciona --</option>
                    <option>A nivel</option>
                    <option>Inclinado</option>
                    <option>Accidentado</option>
                </select>
            </div>
            <div class="field-group" style="flex: 1 1 20%;">
                <label for="estado">Estado Conservación</label>
                <select id="estado" name="estado_conservacion">
                    <option value="">-- Selecciona --</option>
                    <option>Bueno</option>
                    <option>Regular</option>
                    <option>Malo</option>
                </select>
            </div>
            <div class="field-group" style="flex: 1 1 10%;">
                <label for="añoConstruccion">Año</label>
                <input id="añoConstruccion" name="año_construccion" type="number" step="1" placeholder="YYYY">
            </div>
        </div>
    
        <div class="row-container">
            <div class="field-group" style="flex: 1 1 80%;">
                <label for="observaciones">OBSERVACIONES</label>
                <textarea id="observaciones" name="observaciones" rows="2" placeholder="Notas adicionales sobre el levantamiento."></textarea>
                <div class="action-container">
                    <button type="button" id="exportCsv">Exportar a CSV (Local)</button>
                    <button type="submit" id="generateQr">Generar Folio y QR (Servidor)</button>
                </div>
            </div>
            <div class="field-group" style="flex: 0 0 15%;">
                <label>Código QR</label>
                <div id="qrcode">Esperando Folio...</div>
            </div>
        </div>
    </form>
    
    <div class="signatures">
        <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">ELABORÓ</div>
        </div>
        <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">FIRMA DE CONFORMIDAD (Solicitante)</div>
        </div>
        <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">AUTORIZÓ CARTOGRAFÍA</div>
        </div>
        <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">AUTORIZÓ EXPEDIENTE</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // URL del script de backend (ej. un archivo PHP) que manejará los folios y guardará los datos
    const BACKEND_URL = '/api/generar-orden.php'; // Cambiar a la URL real de tu servidor

    // 1. FUNCIONALIDAD DE EXPORTACIÓN Y ENVÍO A BACKEND
    function gatherData(){
        const form = document.getElementById('catastroForm');
        const data = {};
        const elements = form.querySelectorAll('input, select, textarea');
        elements.forEach(element => {
            if (element.id) { // Solo recoge elementos con ID (y name, idealmente)
                data[element.id] = element.value;
            }
        });
        return data;
    }

    // SIMULACIÓN DE ENVÍO AL SERVIDOR
    async function sendToBackend(data){
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = 'Enviando...';

        try {
            // En la vida real, usarías fetch() para enviar los datos al servidor.
            // fetch(BACKEND_URL, {
            //     method: 'POST',
            //     headers: {'Content-Type': 'application/json'},
            //     body: JSON.stringify(data)
            // });

            // SIMULACIÓN DE RESPUESTA DEL SERVIDOR
            await new Promise(resolve => setTimeout(resolve, 1500)); // Espera 1.5s
            
            // EL SERVIDOR DEVUELVE EL FOLIO GENERADO Y LA URL DEL QR
            const serverResponse = {
                success: true,
                folio: 'CATA-' + Math.floor(Math.random() * 10000), // Folio único generado por el backend
                qrImageUrl: 'https://via.placeholder.com/100x100?text=FOLIO%20' + data.clave
            };

            if (serverResponse.success) {
                // Actualiza el campo de folio con el valor devuelto por el servidor
                document.getElementById('folio').value = serverResponse.folio;
                
                // Muestra el QR devuelto
                qrContainer.innerHTML = '';
                const qrImage = document.createElement('img');
                qrImage.src = serverResponse.qrImageUrl;
                qrImage.alt = 'Código QR de la Orden';
                qrImage.style.width = '100%';
                qrImage.style.height = '100%';
                qrContainer.appendChild(qrImage);
                
                alert(`¡Orden guardada! Folio asignado: ${serverResponse.folio}`);
            } else {
                throw new Error('Error en el servidor al generar el folio.');
            }

        } catch(error) {
            qrContainer.innerHTML = 'Error de conexión o servidor.';
            console.error('Error al enviar datos:', error);
            alert('Hubo un error al generar el folio. Intenta de nuevo.');
        }
    }

    // Manejar el submit del formulario (Generar Folio y QR)
    document.getElementById('catastroForm').addEventListener('submit', (e) => {
        e.preventDefault(); // Evita el envío tradicional
        const data = gatherData();
        // Validación básica de campos requeridos (lat/lon/clave)
        if (!data.clave || !data.lat || !data.lon || !data.nombre) {
            alert('Por favor, completa los campos requeridos (Nombre, Clave Catastral, Latitud y Longitud).');
            return;
        }
        sendToBackend(data);
    });

    // Exportar CSV (función local, independiente del servidor)
    document.getElementById('exportCsv').addEventListener('click', () => {
        const data = gatherData();
        const keys = Object.keys(data);
        const escapeCsv = val => '"' + String(val || '').replace(/"/g, '""').replace(/\n/g, ' ') + '"';
        
        const header = keys.join(',');
        const values = keys.map(k => escapeCsv(data[k]));
        
        const csv = header + "\n" + values.join(',');
        
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); 
        a.href = url; 
        a.download = 'Orden_Trabajo_' + data.clave + '.csv'; 
        a.click();
        URL.revokeObjectURL(url);
    });

    // 2. LÓGICA DE MAPA Y FECHA (Se mantiene sin cambios)

    // Establece la fecha actual automáticamente
    document.getElementById('fecha').value = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: '2-digit', day: '2-digit' });

    // Inicialización y lógica del mapa
    const map = L.map('map').setView([19.29, -98.98], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '©️ OSM' }).addTo(map);
    let marker = null;

    function setCoords(lat, lon){
        document.getElementById('lat').value = parseFloat(lat).toFixed(6);
        document.getElementById('lon').value = parseFloat(lon).toFixed(6);
    }
    
    function placeMarker(lat, lon){
        if(marker) { map.removeLayer(marker); }
        marker = L.marker([lat, lon], {draggable:true}).addTo(map);
        marker.on('dragend', e => {
            const p = e.target.getLatLng();
            setCoords(p.lat, p.lng);
        });
        setCoords(lat, lon);
        map.setView([lat, lon], 17);
    }

    map.on('click', function(e){ placeMarker(e.latlng.lat, e.latlng.lng); });

    document.getElementById('useLocation').addEventListener('click', () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                placeMarker(pos.coords.latitude, pos.coords.longitude);
            }, err => alert('No se pudo obtener la ubicación: ' + (err.message || err.code)));
        } else alert('Geolocalización no disponible.');
    });

    document.getElementById('clearMarker').addEventListener('click', () => {
        if(marker){ map.removeLayer(marker); marker = null; }
        document.getElementById('lat').value = '';
        document.getElementById('lon').value = '';
    });

    function updateMarkerFromInputs(){
        const la = parseFloat(document.getElementById('lat').value);
        const lo = parseFloat(document.getElementById('lon').value);
        if(!isNaN(la) && !isNaN(lo) && la>=-90 && la<=90 && lo>=-180 && lo<=180){
            placeMarker(la, lo);
        }
    }
    document.getElementById('lat').addEventListener('change', updateMarkerFromInputs);
    document.getElementById('lon').addEventListener('change', updateMarkerFromInputs);
</script>
</body>
</html>
